<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Locality!</title>
    <link rel="stylesheet" href="css/messi.min.css">
    <link rel="stylesheet" href="css/oval.css">
    <link rel="stylesheet" href="css/bubble-twitter.css">
    <link href='http://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>
    <script src="js/latlon.js"></script>
    <script src="js/live.js"></script>
    <script src="js/messi.min.js"></script>
</head>
<body>
    <div class="footer-container">
        <div class="content">
            <h1>Where's Matt?</h1>
            <h2><em>Warning: contains magic</em></h2>
            <div class="locations"></div>
            <div class="data-out"></div>
            <div class="timeline-container"></div>
        </div>
        <div class="footer">
            Powered by <a href="#" class="latitude-popup">Latitude</a> //
            Fork me on <a href="https://github.com/mplewis/locality">GitHub</a> //
            Tweet me <a href="http://twitter.com/mplewisKesdev">@mplewisKesdev</a>
        </div>
    </div>

    <script>

        var maxDistToValidateLoc = .094697; // miles = 500 ft
        var somewhereElseTitle = 'Somewhere else!';

        var lastFmUsername = "trickybeta";
        var lastFmApiKey = "5c14ae46a8579d7c453edf696ce5efed";
        var listeningText = "♫ Right now I'm listening to ♪";

        var locations = [
            {
                name: "Stadium View",
                coordinates: {
                    latitude: 44.971599,
                    longitude: -93.221807
                }
            },
            {
                name: "Kenneth H. Keller Hall",
                coordinates: {
                    latitude: 44.974650,
                    longitude: -93.232460
                }
            },
            {
                name: "Mondale Hall",
                coordinates: {
                    latitude: 44.97328,
                    longitude: -93.24436
                }
            },
            {
                name: "Centennial Hall",
                coordinates: {
                    latitude: 44.97191,
                    longitude: -93.22952
                }
            },
            {
                name: "Coffman Union",
                coordinates: {
                    latitude: 44.97284,
                    longitude: -93.23539
                }
            },
            {
                name: "Comstock Hall",
                coordinates: {
                    latitude: 44.97232,
                    longitude: -93.23696
                }
            }
        ];
        
        function distKmLatLon(lat1, lon1, lat2, lon2) {
            var p1 = new LatLon(lat1, lon1);
            var p2 = new LatLon(lat2, lon2);
            return p1.distanceTo(p2);
        }

        function distMiLatLon(lat1, lon1, lat2, lon2) {
            var rMi = 3963.1676; // earth's radius in miles
            var p1 = new LatLon(lat1, lon1, rMi);
            var p2 = new LatLon(lat2, lon2, rMi);
            return p1.distanceTo(p2);
        }

        // $('.data-out').text('Fetching data...');

        // get Latitude data as JSONappend
        var latitudeUrl = 'https://latitude.google.com/latitude/apps/badge/api?user=6143439630895179517&type=json';
        // use Yahoo YQL to proxy the JSON into JSONP
        var yahooYqlUrl = 'http://query.yahooapis.com/v1/public/yql?callback=?'

        var timeline = $('.timeline-container');

        for (var i = 0; i < locations.length; i++) {
            var loc = locations[i];
            timeline.append('<div class="timeline-data"><p>' + loc.name + '</p></div>');
        };

        timeline.append('<div class="timeline-data no-right-border somewhere-else"><p>' + somewhereElseTitle + '</p></div>');

        $.getJSON(yahooYqlUrl, {
            q: 'select * from json where url="' + latitudeUrl + '"',
            format: 'json'
        }, function(response) {
            var data = response.query.results.json;
            console.log('Data received!');
            var currLongitude = parseFloat(data.features.geometry.coordinates[0]);
            var currLatitude = parseFloat(data.features.geometry.coordinates[1]);
            var locName = data.features.properties.reverseGeocode;
            // $('.data-out').text(currLatitude + ', ' + currLongitude + ' (' + locName + ')');

            var locSorted = [];

            // use the script from http://www.movable-type.co.uk/scripts/latlong.html to calculate distance
            for (var i = 0; i < locations.length; i++) {
                loc = locations[i];
                locLatitude = loc.coordinates.latitude;
                locLongitude = loc.coordinates.longitude;
                var distance = distMiLatLon(currLatitude, currLongitude, locLatitude, locLongitude)
                locSorted.push({
                    locObj: loc,
                    distance: distance
                });
                console.log(loc, distance);
            };
            
            // sort locations by increasing distance from current Google Latitude coords
            locSorted.sort(function(item1, item2) {return item1.distance - item2.distance});

            var validatedLoc = null;

            for (var i = 0; i < locSorted.length; i++) {
                var loc = locSorted[i];
                var dist = loc.distance;
                var name = loc.locObj.name;
                if (dist < maxDistToValidateLoc) {
                    validatedLoc = name;
                    name = name.toUpperCase();
                }
                // $('.data-out').append('<br/>' + dist + ' mi: ' + name);
            };

            // validatedLoc = null; // for testing "somewhere else"

            console.log('Validated location:', validatedLoc);
            
            if (validatedLoc == null) {
                var jqSomewhereElseBox = $($('.somewhere-else'));
                jqSomewhereElseBox.append('<div class="face" />');
                $('.face').fadeIn('slow');
            } else {
                var dataBoxes = $('.timeline-data');
                for (var i = 0; i < dataBoxes.length; i++) {
                    var dataBox = dataBoxes[i];
                    var jqDataBox = $(dataBox);
                    var dataBoxText = jqDataBox.text().trim();
                    if (dataBoxText.indexOf(validatedLoc) > -1) {
                        jqDataBox.append('<div class="face" />');
                        $('.face').fadeIn('slow');
                    }
                };
            }

            $.getJSON("http://ws.audioscrobbler.com/2.0/",
                {
                    method: "user.getrecenttracks",
                    user: lastFmUsername,
                    api_key: lastFmApiKey,
                    format: "json",
                    limit: 1
                },
                function(data) {
                    var track = data["recenttracks"]["track"][0]
                    console.log(track);

                    var artist = track["artist"]["#text"];
                    var artistMbid = track["artist"]["mbid"];
                    var title = track["name"];
                    var trackUrl = track["url"];
                    
                    if (!("date" in track)) {
                        console.log('Listening now!');
                        $('.face').append('<p class="bubble-twitter"><strong>' + listeningText + '</strong><br />' + title + ' by ' + artist + '</p>');
                    } else {
                        console.log('Not listening right now.');
                    }

                }
            );
        });

        $('.latitude-popup').click(function() {
            var messiHtml = '<iframe src="http://latitude.google.com/latitude/apps/badge/api?user=6143439630895179517&type=iframe&maptype=roadmap" width="480" height="400" frameborder="0"></iframe>';
            new Messi(messiHtml, {title: 'Google Latitude', modal: true});
        });

        $('.timeline-data').hover(function() {
            $('.face').addClass('face-hover');
        }, function() {
            $('.face').removeClass('face-hover');
        });
        
    </script>
</body>
</html>